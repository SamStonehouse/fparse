<!DOCTYPE html>
<html>
<head>
<meta name="author" content="Alexander Schenkel">
<meta name="description" content="JavaScript Formula Parser library and demonstration of its usage.">
<meta name="keywords" content="JavaScript,JS,Formula,Formula Parser,Parser,Formula Library">
<meta name="robots" content="all">

<style type="text/css">
body,table {
	font-family: sans-serif;
	font-size: 10pt;
}


#left {
	float:left;
	width:400px;
}

#right {
	margin-left: 400px;
	margin-right: 20px;
	padding:10px;
	background-color: #EEE;
	border: 1px solid #888;
	
	
}

.formulaTable {
	padding: 5px;
	margin-bottom: 20px;
	background-color: #EEE;
	margin-right: 20px;
	border: 1px solid #888;
}

.formulaTable label {
	display: inline-block;
	width: 80px;
}

#canvasHeader {
	margin: 5px;
	height: 80px;
	
}

#drawFunctions {
	float: right;
	width: 200px;
	text-align: right;
}



#canvas {
	width: 100%; 
	height: 500px;
}

#valueDisplay {
	padding: 5px;
	border: 1px solid #888;
	margin: 5px;
}


</style>
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/flot/jquery.flot.js"></script>
<script src="fparser.js"></script>
<script type="text/javascript">

function saveSettings() {
	var store = window.localStorage;
	if (window.localStorage) {
		// Save simple text values:
		store.setItem('formula',$('#formula').val());
		store.setItem('xValue',$('#xValue').val());
		store.setItem('minX',$('#minX').val());
		store.setItem('maxX',$('#maxX').val());
		store.setItem('minY',$('#minY').val());
		store.setItem('maxY',$('#maxY').val());
		store.setItem('xInc',$('#xInc').val());
		store.setItem('calcDiffs',$('#calcDiffs').attr('checked') === 'checked');
		
		// Save formula entries:
		var formulas = [];
		$('#formulaContainer').children().each(function(ind,item){
			var fStr = $(item).data('formula');
			formulas.push(fStr);
		});
		store.setItem('formulas',JSON.stringify(formulas));
		
	}
}

function loadSettings() {
	var store = window.localStorage;
	var ret = false;
	var loadAndSetIf = function(fieldId) {
		var val = store.getItem(fieldId);
		if (val) {
			ret = true;
			$('#'+fieldId).val(val);
		}
	};
	
	if (window.localStorage) {
		// Load simple string fields:
		loadAndSetIf('formula');
		loadAndSetIf('xValue');
		loadAndSetIf('minX');
		loadAndSetIf('maxX');
		loadAndSetIf('minY');
		loadAndSetIf('maxY');
		loadAndSetIf('xInc');
		
		$('#calcDiffs').attr('checked',store.getItem('calcDiffs')==='true'?'checked':null);
		
		// Load formulas:
		try {
			var formulas = JSON.parse(store.getItem('formulas'));
			if (formulas) {
				for (var i = 0; i < formulas.length; i++) {
					addFormula(formulas[i]);
				}
			}
		} catch (e) {}
	}
	return ret;
}



function calc() {
	var formula = document.getElementById('formula').value;
	var x = Number(Formula.calc(document.getElementById('xValue').value));
	var obj = new Formula(formula);
	res = obj.evaluate({x: x});
	document.getElementById('xResult').value = res.toFixed(3);
}

/**
 * f: function to differentiate
 * x: differentiate at point x
 * d: distance to use for numeric differentiation
 *
 *
 * Differential is calculated the following way:
 *
 * f'(x) = (f(x+d/2) - f(x-d/2)) / d
 * 
 */
function dX(f,x,d) {
	return (f(x+d/2) - f(x-d/2))/d;
}


function plot(withDx) {
	withDx = withDx || false;
	
	var minX = Formula.calc(document.getElementById('minX').value);
	var maxX = Formula.calc(document.getElementById('maxX').value);
	var minY = Formula.calc(document.getElementById('minY').value);
	var maxY = Formula.calc(document.getElementById('maxY').value);
	var xInc = Formula.calc(document.getElementById('xInc').value);
	
	var series = [];
	var options = {
		xaxis:{
			min: minX,
			max:maxX
		},
		yaxis:{
			min:minY,
			max:maxY
		},
		grid: {
			backgroundColor: { colors: ["#FFF", "#CCC"] },
			hoverable: true,
			clickable: true
		  }
	}; 
	
	var formulas = $('#formulaContainer').children().each(function(ind,item){
		var formula = $(item).data('formula');
		var formulaObj = new Formula(formula);
		var data = [];
		var dXdata = [];
		for (var x = minX; x <= maxX; x+=xInc) {
			data.push([x,formulaObj.evaluate({x:x})]);
			if (withDx) {
				dXdata.push([x,dX(function(xVal){
					return formulaObj.evaluate({x:xVal});
				},x,xInc)]);
			}
		}
		var serie = {
			id: $(item).data('fId'),
			data: data,
			label: 'y = '+formula,
			hoverable: true,
			clickable: true
		};
		series.push(serie);
		if (withDx) {
			var dXserie = {
				data: dXdata,
				label: 'y = d(x): '+formula,
				hoverable: true,
				clickable: true
			};
			series.push(dXserie);
		}
	});
	$.plot($("#canvas"),series,options);
}

function draw() {
	if ($('#calcDiffs').attr('checked') === 'checked') {
		plot(true);
	} else {
		plot(false);
	}
	
}



var idCount = 0;
function addFormula(formula) {
	var fDiv = $('<div><\/div>');
	var txt = $('<span>'+formula+'<\/span>');
	var del = $('<button>del<\/button>');
	del.on('click',function() {
		fDiv.remove();
		saveSettings();
		draw();
	});
	fDiv.append(del);
	fDiv.append(txt);
	fDiv.data('fId',++idCount);
	fDiv.data('formula',formula);
	
	$('#formulaContainer').append(fDiv);
	saveSettings();
}

function addAndDraw() {
	addFormula(document.getElementById('formula').value);
	draw();
}




function findOptima() {
	var minX = Number($('#minX').val());
	var maxX = Number($('#maxX').val());
	var xInc = Number($('#minOptDist').val());
	var formulas = $('#formulaContainer').children();
	
	for (var i = 0; i < formulas.length; i++) {
		(function(fStr) {
			
			var fObj = new Formula(fStr);
			var zeros = [];
			var dx= 0;
			var prevdx = 0;
			var j = 0;
			
			// search for a change of the differential sign: If 
			// prevDy has another sign than dY, we found an optimum in between.
			for (j = minX; j <= maxX; j+= xInc) {
				dx = dX(function(x){
						return fObj.evaluate({x: x});
				}, j, xInc);
				if (dx === 0) {
					// We found an optimum, save it:
					zeros.push([j, fObj.evaluate({x: j})]);
				} else if (dx * prevdx < 0) {
					// Change of sign, found an optimum between last x and x)
					
					//TODO
				}
			}
			
		}($(formulas[i]).data('formula')));
	}
	
	
}



$(document).ready(function(){
	// Load settings from localStorage HTML5 object, if available:
	loadSettings();
	
	// RUn startup calc & painting:
	calc();
	if ($('#formulaContainer').children().length > 0) {
		draw();
	} else {
		addAndDraw();
	}
	
	
	$('#calcBtn').on('click',calc);
	$('#drawBtn').on('click',addAndDraw);
	$('#calcDiffs').on('click',draw);
	$('#redrawGraph').on('click',draw);
	$('#findOptimaBtn').on('click',findOptima);
	
	
	// Local store save handlers:
	$('#formula').on('blur', saveSettings);
	$('#xValue').on('blur', saveSettings);
	$('#minX').on('blur', saveSettings);
	$('#maxX').on('blur', saveSettings);
	$('#minY').on('blur', saveSettings);
	$('#maxY').on('blur', saveSettings);
	$('#xInc').on('blur', saveSettings);
	$('#calcDiffs').on('click',saveSettings);
	
	
	$("#canvas").bind("plothover", function (event, pos, item) {
		if (item) {
			var col = item.series.color;
			$('#x').css({color: col,textShadow:'1px 1px 0px #888'});
			$('#y').css({color: col,textShadow:'1px 1px 0px #888'});
			$("#x").text(item.datapoint[0].toFixed(3));
			$("#y").text(item.datapoint[1].toFixed(3));
		} else {
			$("#x").text('');
			$("#y").text('');
		}
        

        /*
        if ($("#enableTooltip:checked").length > 0) {
            if (item) {
                if (previousPoint != item.dataIndex) {
                    previousPoint = item.dataIndex;
                    
                    $("#tooltip").remove();
                    var x = item.datapoint[0].toFixed(2),
                        y = item.datapoint[1].toFixed(2);
                    
                    showTooltip(item.pageX, item.pageY,
                                item.series.label + " of " + x + " = " + y);
                }
            }
            else {
                $("#tooltip").remove();
                previousPoint = null;            
            }
        }
        */
    });
});






</script>
</head>
<body>
<header>
<h1>JS Formula parser &amp; Demo </h1>
<p>Demo page for my Formula parser library: Parses strings into evaluatable mathematical expressions.
Check <a href="javascript:window.open('view-source:'+window.location.href)">page source</a> for all relevant source code :-)
<br />
<strong>Note:</strong> This demo uses <a href="http://jquery.com" target="_blank">jQuery</a> and <a href="http://code.google.com/p/flot/" target="_blank">the flot library</a>.<br />
<strong>Note 2:</strong> This page can only be viewed with a <em>real</em> browser (so Firefox or Chrome).
</p>
</header>
<div id="left">
<div>
Known expressions:
<ul>
	<li>Numbers in the form [-]digits[.digits], e.g. "-133.2945"</li>
	<li>simple operators: '+','-','*','/', expanded in correct order</li>
	<li>parentheses '(', ')' for grouping (e.g. "5*(3+2)")</li>
	<li>all JavaScript Math object functions (e.g. "sin(3.14)")</li>
	<li>all JavaScript Math constants like PI, E</li>
	<li>the use of own functions, (not in this demo, see in code)</li>
	<li>the use of variables (in this demo, only x is allowed)</li>
	<li>Example:<br /> <code>-1*(sin(pow(2,x)/(PI*x))*cos(x))</code></li>
</ul>
</div>
<fieldset class="formulaTable">
	<legend>Enter formula</legend>
	<textarea id="formula" style="width: 90%;">1/log(pow(2,x))*sin(x)</textarea><br />
	<button id="drawBtn">add</button>
</fieldset>

<fieldset class="formulaTable">
	<legend>Evaluate single value</legend>
	<div>
		<label>Value for x:</label> <input id="xValue" value="PI*3/4" />
	</div>
	<div>
		<label>Result:</label> <input id="xResult" />
	</div>
	<button id="calcBtn">calc</button>
</fieldset>

<fieldset class="formulaTable">
	<legend>Formulas</legend>
	<div id="formulaContainer"></div>
	
</fieldset>
</div>
<div id="right">
	<div id="canvasHeader">
		<div id="xValues">
			<div id="drawFunctions">
				<div>
					<input type="checkbox" id="calcDiffs" /><label for="calcDiffs">Calculate differentials</label>
				</div>
				<!--
				<div>
					<button id="findOptimaBtn">Find minima / maxima</button><br />
					min opt. dist.: <input id="minOptDist" value="1" />
				</div>
				-->
			</div>
			
			minX: <input id="minX" value="0"/> maxX: <input id="maxX" value="80*PI"/> x inc: <input id="xInc" value="PI/32"/><br />
			minY: <input id="minY" value="-0.2"/> maxY: <input id="maxY" value="0.2"/><button id="redrawGraph">redraw</button>
			
		</div>
</div>
<div id="valueDisplay">X: <span id="x"></span><br />Y: <span id="y"></span></div>
<div id="canvas"></div>
</div>


















<div id="usage">
<h2>Library Usage</h2>
<p>For those interested in using the parsing library, just follow those instructions:</p>

<h3>1. Get the Formula JS-Object</h3>
Just include the <a href="fparser.js" target="_blank">fparser.js</a> in your HTML header:
<pre><code>&lt;script src="fparser.js"&gt;&lt;/script&gt;</code></pre>
This defines a global Formula object constructor.  

<h3>2. Create a Formula object instance</h3>
Simple usage:
<pre><code>//Step 1: create a formula object by passing a formula string:
var myFormulaStr = 'pow(2,x)';
var fObj         = new Formula(myFormulaStr);

// Step 2: evaluate the formula, delivering a value object for each unknown entity:
var result = fObj.evaluate({x: 3}); // result = 8

// or deliver multiple value objects to return multiple results:
var results = fObj.evaluate([{x: 2},{x: 4},{x: 8}]); // results = [4,16,256]
</code></pre>

<h3>3. Advanced usage</h3>
Using multiple unknown variables:
<pre><code>var fStr = 'a*pow(x,2) + b*x + c';
var fObj = new Formula(fStr);

// Just pass a value object containing a value for each unknown variable:
var result = fObj.evaluate({a:2,b:-1,c:3,x:3}); // result = 18
</code></pre>

Using user-defined functions:
<pre><code>var fStr = 'sin(mInv(x))';
var fObj = new Formula(fStr);

// Just pass functions unknown to the Math object as function in the value object:
var result = fObj.evaluate({
	x: 2/Math.PI, 
	mInv: function(value){
		return 1/value;
	}
});

// result = 1;
</code></pre>
</div>
</body>
</html>
